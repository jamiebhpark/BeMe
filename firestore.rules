rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ───────────────────────── 1. users/{uid} ───────────────────────── */
    match /users/{uid} {
      function isOwner()        { return request.auth != null && request.auth.uid == uid; }
      function userAllowedKeys(){ return request.resource.data.keys().hasOnly([
        'nickname','bio','location',
        'profileImageURL','profileImageUpdatedAt','fcmToken'
      ]); }

      allow create: if isOwner()
                    && userAllowedKeys()
                    && request.resource.data.keys().hasAny(['nickname']);
      allow update: if isOwner() && userAllowedKeys();
      allow read  : if isOwner();

      /* participations 서브컬렉션 */
      match /participations/{docId} {
        allow read, write: if isOwner();
      }
    }

    /* ───────────────────────── 2. challenges/{id} ───────────────────── */
    match /challenges/{id} {
      allow read : if true;
      allow write: if false;                 // Admin SDK(Cloud Functions)만 수정
    }

    /* ───────────────────────── 3. challengePosts/{postId} ───────────── */
    match /challengePosts/{postId} {
      function isOwner() {
        return request.auth != null
               && request.resource.data.userId == request.auth.uid;
      }

      /* 필드 화이트리스트 */
      function postAllowedKeys() {
        return request.resource.data.keys().hasOnly([
          'userId','challengeId','imageUrl',
          'createdAt','reactions','reported','caption'
        ]);
      }

      /* ───── Create ───── */
      allow create: if isOwner()
                    && postAllowedKeys()
                    && request.resource.data.keys().hasAll([
                         'userId','challengeId','imageUrl','createdAt'
                       ])
                    /* reported 필드는 항상 false 로 시작 */
                    && request.resource.data.reported is bool
                    && request.resource.data.reported == false;

      /* ───── Delete ───── */
      allow delete: if resource.data.userId == request.auth.uid;

      /* 업데이트 금지 */
      allow update: if false;

      /* 읽기 전체 허용 */
      allow read   : if true;
    }

    /* ───────────────────────── 4. 기본 거절 ─────────────────────────── */
    match /{document=**} { allow read, write: if false; }
  }
}
